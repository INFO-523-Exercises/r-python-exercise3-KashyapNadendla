---
title: "r-python-exercise3-KashyapNadendla"
format: html
editor: visual
---

## SETUP

```{r}

if(!require(pacman))
  install.packages("pacman")

install.packages("~/Downloads/FSelector_0.34-2.tar", repos = NULL, type = "source")

install.packages("FSelector")
pacman::p_load(tidyverse, rpart, rpart.plot, caret, 
  lattice, sampling, pROC, mlbench,FSelector)
```

## Loading the dataset

```{r}

data(Zoo, package="mlbench")
head(Zoo)
```

```{r}

as_tibble(Zoo, rownames = "animal")
```

```{r warning=FALSE}

Zoo <- Zoo |>
  mutate(across(where(is.logical), factor, levels = c(TRUE, FALSE))) |>
  mutate(across(where(is.character), factor))
```

```{r}

summary(Zoo)
```

## Decision Trees

```{r}

library(rpart)

tree_default <- Zoo |> 
  rpart(type ~ ., data = _)
tree_default
```

```{r}

library(rpart.plot)
rpart.plot(tree_default, extra = 2)
```

## Create a Full Tree

```{r}

tree_full <- Zoo |> 
  rpart(type ~ . , data = _, 
        control = rpart.control(minsplit = 2, cp = 0))
rpart.plot(tree_full, extra = 2, 
           roundint=FALSE,
            box.palette = list("Gy", "Gn", "Bu", "Bn", 
                               "Or", "Rd", "Pu")) # specify 7 colors
```

```{r}

tree_full
```

```{r}

predict(tree_default, Zoo) |> head ()
```

```{r}

pred <- predict(tree_default, Zoo, type="class")
head(pred)
```

```{r}

confusion_table <- with(Zoo, table(type, pred))
confusion_table
```

```{r}

correct <- confusion_table |> diag() |> sum()
correct
```

```{r}

error <- confusion_table |> sum() - correct
error
```

```{r}

accuracy <- correct / (correct + error)
accuracy
```

### Using a function for accuracy

```{r}

accuracy <- function(truth,prediction){
  tbl <- table(truth,prediction)
  sum(diag(tbl)/sum(tbl))
}

accuracy(Zoo |> pull(type), pred)
```

### Training error of the full tree

```{r}

accuracy(Zoo |> pull(type), 
         predict(tree_full, Zoo, type = "class"))
```

### Get a confusion table with more statistics (using caret)

```{r}

library(caret)
confusionMatrix(data = pred, 
                reference = Zoo |> pull(type))
```

## Make Predictions for New Data

Making our own animal: A lion with featured wings!

```{r}

my_animal <- tibble(hair = TRUE, feathers = TRUE, eggs = FALSE,
  milk = TRUE, airborne = TRUE, aquatic = FALSE, predator = TRUE,
  toothed = TRUE, backbone = TRUE, breathes = TRUE, venomous = FALSE,
  fins = FALSE, legs = 4, tail = TRUE, domestic = FALSE,
  catsize = FALSE, type = NA)
```

Fixing columns to be factors like in the training set.

```{r}

my_animal <- my_animal |> 
  mutate(across(where(is.logical), factor, levels = c(TRUE, FALSE)))
my_animal
```

Making a prediction using the default tree

```{r}

predict(tree_default , my_animal, type = "class")
```

## Model Evaluation with Caret

```{r}

library(caret)
```

```{r}

set.seed(2000)
```

## Hold out Test data

```{r}

inTrain <- createDataPartition(y = Zoo$type, p = .8, list = FALSE)
Zoo_train <- Zoo |> slice(inTrain)
```

```{r}

Zoo_test <- Zoo |> slice(-inTrain)
```

## Learn a Model and Tune Hyperparameters on the Training Data

```{r}

fit <- Zoo_train |>
  train(type ~.,
    data = _,
    method="rpart",
    control = rpart.control(minsplit = 2),
    trControl = trainControl(method = "cv", number = 10),
    tuneLength = 5
  )

fit
```

```{r}

rpart.plot(fit$finalModel, extra = 2,
  box.palette = list("Gy", "Gn", "Bu", "Bn", "Or", "Rd", "Pu"))
```

```{r}

varImp(fit)
```

The variable importance without competing splits.

```{r}

imp <- varImp(fit, compete = FALSE)
imp
```

```{r}

ggplot(imp)
```

## **Testing: Confusion Matrix and Confidence Interval for Accuracy**

```{r}

pred <- predict(fit, newdata = Zoo_test)
pred
```

```{r}

confusionMatrix(data = pred, 
                ref = Zoo_test |> pull(type))
```

## Model Comparison

```{r}

train_index <- createFolds(Zoo_train$type, k = 10)

```

Building models

```{r}

rpartFit <- Zoo_train |> 
  train(type ~ .,
        data = _,
        method = "rpart",
        tuneLength = 10,
        trControl = trainControl(method = "cv", indexOut = train_index)
  )
```

```{r}

knnFit <- Zoo_train |> 
  train(type ~ .,
        data = _,
        method = "knn",
        preProcess = "scale",
          tuneLength = 10,
          trControl = trainControl(method = "cv", indexOut = train_index)
  )
```

comparing accuracy over all folds

```{r}

resamps <- resamples(list(
        CART = rpartFit,
        kNearestNeighbors = knnFit
        ))

summary(resamps)
```

```{r}

library(lattice)
bwplot(resamps, layout = c(3, 1))
```

```{r}

difs <- diff(resamps)
difs
```

```{r}

summary(difs)
```

## **Feature Selection and Feature Preparation**

```{r}

library(FSelector)

```

```{r}

weights <- Zoo_train |> 
  chi.squared(type ~ ., data = _) |>
  as_tibble(rownames = "feature") |>
  arrange(desc(attr_importance))

weights
```

```{r}

```

```{r}

```

```{r}

```

```{r}

```
